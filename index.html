<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SSC Tracker - Prep Companion</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js" defer></script>
  <style>
    :root {
      --bs-primary-rgb: 99, 102, 241; /* Indigo */
      --bs-secondary-rgb: 139, 92, 246; /* Violet */
      --bs-success-rgb: 34, 197, 94; /* Green */
      --bs-warning-rgb: 245, 158, 11; /* Amber */
      --bs-danger-rgb: 239, 68, 68; /* Red */
      --bs-body-font-family: 'Inter', sans-serif;
      --bs-body-bg: #f8fafc; /* Light Gray */
      --bs-body-color: #0f172a; /* Slate 900 */
    }

    body {
      background-color: var(--bs-body-bg);
      color: var(--bs-body-color);
      min-height: 100vh;
    }

    .navbar {
      background-color: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .gradient-text {
      background: linear-gradient(45deg, rgb(var(--bs-primary-rgb)), rgb(var(--bs-secondary-rgb)));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .card {
      border: none;
      border-radius: 0.75rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
    }

    .chart-container {
      height: 300px; /* Adjust as needed */
      position: relative;
      margin-top: 1rem; /* Add space above charts */
      padding: 1rem; /* Padding inside card for chart */
    }

     .spinner-overlay {
       position: fixed;
       top: 0;
       left: 0;
       width: 100%;
       height: 100%;
       background: rgba(255, 255, 255, 0.8); /* Light overlay */
       display: flex;
       flex-direction: column; /* Stack spinner and text */
       align-items: center;
       justify-content: center;
       z-index: 9999;
       opacity: 0; /* Initially hidden */
       visibility: hidden; /* Initially hidden */
       transition: opacity 0.3s ease, visibility 0s linear 0.3s; /* Delay visibility transition */
     }

     .spinner-overlay.active {
        opacity: 1;
        visibility: visible;
        transition: opacity 0.3s ease, visibility 0s linear 0s;
     }

     #spinnerText {
       margin-top: 1rem; /* Space between spinner and text */
       color: rgb(var(--bs-primary-rgb)); /* Use primary color */
       font-weight: 500;
     }

     .form-label {
        font-weight: 500;
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
     }
     .form-control, .form-select {
         background-color: #f1f5f9; /* Lighter input background */
         border: 1px solid #e2e8f0; /* Subtle border */
     }
      .form-control:focus, .form-select:focus {
         background-color: #fff;
         border-color: rgba(var(--bs-primary-rgb), 0.5);
         box-shadow: 0 0 0 3px rgba(var(--bs-primary-rgb), 0.15);
      }

      #textAnalysis a {
          color: rgb(var(--bs-primary-rgb));
          text-decoration: none;
      }
       #textAnalysis a:hover {
          text-decoration: underline;
      }
       .alert {
            margin-top: 1.5rem;
       }
       .section-heading {
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid rgba(var(--bs-primary-rgb), 0.2);
            display: inline-block;
       }

       @media (min-width: 768px) {
           .dashboard-grid {
               display: grid;
               grid-template-columns: repeat(2, 1fr); /* Two columns for charts */
               gap: 1.5rem;
           }
           .text-analysis-card {
              grid-column: span 2; /* Make text analysis span both columns */
           }
       }
        @media (min-width: 992px) {
           .dashboard-grid {
               grid-template-columns: repeat(3, 1fr); /* Three columns for charts on larger screens */
               align-items: start; /* Align items to the top */
           }
            .text-analysis-card {
              grid-column: span 3; /* Span all three */
           }
        }


  </style>
</head>
<body>
  <div class="spinner-overlay" id="spinnerOverlay">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
    <div id="spinnerText">Processing...</div>
  </div>

  <nav class="navbar navbar-expand-lg fixed-top">
    <div class="container">
      <a class="navbar-brand gradient-text fw-bold fs-4" href="#">SSC Tracker</a>
      <button class="btn btn-outline-primary ms-auto" id="refreshDataBtn" title="Refresh Data">
           <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
             <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
             <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
           </svg>
           Refresh
       </button>
    </div>
  </nav>

  <main class="container" style="padding-top: 80px; padding-bottom: 40px;">

    <div id="alertPlaceholder" class="mb-4"></div>

    <section class="card mb-4">
      <div class="card-body p-4">
        <h3 class="gradient-text mb-4 section-heading">Enter New Test Result</h3>
        <form id="testEntryForm">
          <div class="row g-3 mb-3">
            <div class="col-md-3">
              <label for="testDate" class="form-label">Test Date</label>
              <input type="date" id="testDate" class="form-control" required>
            </div>
            <div class="col-md-3">
               <label for="provider" class="form-label">Provider</label>
              <select id="provider" class="form-select">
                <option value="Oliveboard">Oliveboard</option>
                <option value="RBE">RBE</option>
                <option value="Testbook">Testbook</option>
                <option value="The Pundits">The Pundits</option>
                 <option value="Other">Other</option>
              </select>
            </div>
            <div class="col-md-3">
               <label for="testType" class="form-label">Test Type</label>
              <select id="testType" class="form-select">
                <option value="full">Full Test</option>
                <option value="sectional">Sectional</option>
              </select>
            </div>
             <div class="col-md-3">
                 <label for="notes" class="form-label">Notes (Optional)</label>
                 <input type="text" id="notes" class="form-control" placeholder="e.g., CGL Mock 5, Weak in Algebra">
             </div>
          </div>

          <div id="fullTestInputs" class="row g-3 mb-3">
            <div class="col-md-3 col-6">
              <label for="maths" class="form-label">Maths</label>
              <input type="number" id="maths" class="form-control" min="0" max="50" step="any" placeholder="Score / 50">
            </div>
            <div class="col-md-3 col-6">
              <label for="english" class="form-label">English</label>
              <input type="number" id="english" class="form-control" min="0" max="50" step="any" placeholder="Score / 50">
            </div>
            <div class="col-md-3 col-6">
              <label for="reasoning" class="form-label">Reasoning</label>
              <input type="number" id="reasoning" class="form-control" min="0" max="50" step="any" placeholder="Score / 50">
            </div>
            <div class="col-md-3 col-6">
              <label for="gk" class="form-label">GK</label>
              <input type="number" id="gk" class="form-control" min="0" max="50" step="any" placeholder="Score / 50">
            </div>
          </div>

          <div id="sectionalInputs" class="row g-3 mb-3" style="display: none;">
            <div class="col-md-6">
              <label for="section" class="form-label">Section</label>
              <select id="section" class="form-select">
                <option>Maths</option>
                <option>English</option>
                <option>Reasoning</option>
                <option>GK</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="sectionMarks" class="form-label">Marks</label>
              <input type="number" id="sectionMarks" class="form-control" placeholder="Score / 50" min="0" max="50" step="any">
            </div>
          </div>

          <button type="submit" class="btn btn-primary w-100 mt-3">Save Entry</button>
        </form>
      </div>
    </section>

    <section>
       <h3 class="gradient-text mb-4 section-heading">Performance Analytics</h3>

       <div class="dashboard-grid">
           <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Overall Score Trend (Full Tests)</h5>
                    <div class="chart-container">
                      <canvas id="progressChart"></canvas>
                    </div>
                </div>
           </div>

           <div class="card">
                 <div class="card-body">
                     <h5 class="card-title">Average Score per Section (Full Tests)</h5>
                     <div class="chart-container">
                       <canvas id="sectionAvgChart"></canvas>
                     </div>
                 </div>
            </div>

           <div class="card">
                 <div class="card-body">
                     <h5 class="card-title">Average Score by Provider (Full Tests)</h5>
                     <div class="chart-container">
                       <canvas id="providerAvgChart"></canvas>
                     </div>
                 </div>
            </div>


            <div class="card text-analysis-card">
                <div class="card-body">
                    <h5 class="card-title">Quick Analysis</h5>
                    <div id="textAnalysis" class="mt-3 mb-4">
                        <p class="text-muted">Loading analysis...</p>
                    </div>
                     <button class="btn btn-secondary w-100" id="pdfBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-pdf me-2" viewBox="0 0 16 16">
                          <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/>
                          <path d="M4.603 14.087a.8.8 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.7 7.7 0 0 1 1.482-.645 20 20 0 0 0 1.062-2.227 7.3 7.3 0 0 1-.43-1.295c-.086-.4-.119-.796-.046-1.136.075-.354.274-.672.658-.823.192-.077.4-.12.602-.077a.7.7 0 0 1 .477.365c.088.164.12.356.127.538.007.188-.012.396-.047.614-.084.51-.27 1.134-.52 1.794a11 11 0 0 0 .98 1.686 5.8 5.8 0 0 1 1.334.05c.364.066.734.195.96.465.313.37.436.89.405 1.442-.03.515-.25 1.056-.588 1.467-.36.421-.86.62-1.442.725a6.4 6.4 0 0 1-1.113.046c-.5-.026-1.09-.156-1.46-.375a.5.5 0 0 1-.057-.05 3.1 3.1 0 0 1-.254-.434c-.049-.097-.087-.202-.127-.318a.7.7 0 0 1-.028-.092c-.01-.03-.01-.07-.011-.11zm1.51-8.853.04.08.016.044.016.044a.8.8 0 0 0 .108.141.9.9 0 0 0 .469.318c.069.01.142.015.215.005.09-.013.176-.037.25-.069.212-.09.37-.25.46-.47a.9.9 0 0 0 .01-.75.8.8 0 0 0-.2-.4c-.065-.07-.155-.11-.254-.14-.085-.026-.175-.041-.27-.046l-.105-.003c-.108-.003-.21-.003-.31-.003a1 1 0 0 0-.528.076.9.9 0 0 0-.448.275l-.036.04-.01.012-.002.002zm-.21-2.53a.6.6 0 0 0-.036.052c-.05.096-.076.21-.076.332 0 .137.04.27.123.39l.017.025.017.024a.4.4 0 0 0 .05.06c.08.09.19.14.31.162l.117.01.112.003c.105-.002.21-.005.316-.01a.6.6 0 0 0 .5-.2.8.8 0 0 0 .15-.31c.03-.08.04-.16.04-.23 0-.08-.01-.17-.03-.24a.7.7 0 0 0-.14-.3c-.07-.09-.16-.16-.27-.2-.1-.04-.2-.06-.3-.07a.9.9 0 0 0-.3-.01c-.13.01-.26.03-.38.06a.6.6 0 0 0-.23.11l-.002.001z"/>
                        </svg>
                        Generate Performance Report (PDF)
                    </button>
                </div>
            </div>
       </div>

    </section>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

  <script>
    // --- Configuration ---
    // !! IMPORTANT: Replace with your Deployed Google Apps Script Web App URL !!
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxAIi9huCzHb0AE3ufMmIS2CYLjRF-mBhObPUHkoNhVWln4bAJzIWNIcRQlcKsz8WE5/exec";

    // --- Global Variables ---
    let allTestData = []; // To store data fetched from Google Sheet
    let progressChartInstance = null;
    let sectionAvgChartInstance = null;
    let providerAvgChartInstance = null;
    const { jsPDF } = window.jspdf; // For easier access
    const { autoTable } = window.jspdf.plugin.autotable; // For easier access

    // --- DOM Elements ---
    const form = document.getElementById('testEntryForm');
    const testTypeSelect = document.getElementById('testType');
    const fullTestInputsDiv = document.getElementById('fullTestInputs');
    const sectionalInputsDiv = document.getElementById('sectionalInputs');
    const spinnerOverlay = document.getElementById('spinnerOverlay');
    const spinnerText = document.getElementById('spinnerText');
    const alertPlaceholder = document.getElementById('alertPlaceholder');
    const pdfBtn = document.getElementById('pdfBtn');
    const refreshDataBtn = document.getElementById('refreshDataBtn');

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
      // Set default date to today
      document.getElementById('testDate').valueAsDate = new Date();

      // Add event listeners
      testTypeSelect.addEventListener('change', toggleTestInputs);
      form.addEventListener('submit', handleFormSubmit);
      pdfBtn.addEventListener('click', generatePdfReport);
      refreshDataBtn.addEventListener('click', fetchData);


      // Initial setup
      toggleTestInputs(); // Set initial visibility based on default selection
      fetchData(); // Fetch data when the page loads
    });

    // --- UI Functions ---
    function toggleTestInputs() {
      if (testTypeSelect.value === 'full') {
        fullTestInputsDiv.style.display = 'flex'; // Use flex for row layout
        sectionalInputsDiv.style.display = 'none';
        // Make full test inputs required (optional, server validation is key)
        setRequired(['maths', 'english', 'reasoning', 'gk'], true);
        setRequired(['section', 'sectionMarks'], false);
      } else {
        fullTestInputsDiv.style.display = 'none';
        sectionalInputsDiv.style.display = 'flex'; // Use flex for row layout
         setRequired(['maths', 'english', 'reasoning', 'gk'], false);
         setRequired(['section', 'sectionMarks'], true);
      }
    }

    function setRequired(ids, isRequired) {
        ids.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.required = isRequired;
            }
        });
    }


    function showSpinner(text = 'Processing...') {
        spinnerText.textContent = text;
        spinnerOverlay.classList.add('active');

    }

    function hideSpinner() {
       spinnerOverlay.classList.remove('active');
    }

    function showAlert(message, type = 'info') {
        // Types: primary, secondary, success, danger, warning, info, light, dark
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        alertPlaceholder.innerHTML = ''; // Clear previous alerts
        alertPlaceholder.append(wrapper);

         // Auto-dismiss after 5 seconds for success/info
         if (type === 'success' || type === 'info') {
             setTimeout(() => {
                 const alertInstance = bootstrap.Alert.getOrCreateInstance(wrapper.firstChild);
                 if (alertInstance) {
                     alertInstance.close();
                 }
             }, 5000);
         }
    }

    // --- Data Handling ---
    async function fetchData() {
      showSpinner('Fetching your data...');
      try {
        const response = await fetch(SCRIPT_URL); // GET request by default
        if (!response.ok) {
            let errorMsg = `HTTP error! Status: ${response.status}`;
            try {
                const errorData = await response.json();
                errorMsg = errorData.message || errorMsg;
            } catch(e) { /* Ignore if response is not JSON */ }
             throw new Error(errorMsg);
        }
        const result = await response.json();

        if (result.status === 'success') {
          allTestData = result.data || []; // Store fetched data globally
          console.log("Data fetched:", allTestData);
          updateDashboard(); // Update charts and analysis
          showAlert('Data refreshed successfully!', 'success');
        } else {
          throw new Error(result.message || 'Failed to fetch data from script.');
        }
      } catch (error) {
        console.error("Error fetching data:", error);
        showAlert(`Error fetching data: ${error.message}. Please ensure you are logged in and have granted permissions to the script.`, 'danger');
         // Display minimal dashboard if data fails
         allTestData = [];
         updateDashboard();
      } finally {
        hideSpinner();
      }
    }

    async function handleFormSubmit(event) {
      event.preventDefault(); // Prevent default form submission
      showSpinner('Saving entry...');

      const formData = {
        testDate: document.getElementById('testDate').value,
        provider: document.getElementById('provider').value,
        testType: document.getElementById('testType').value,
        notes: document.getElementById('notes').value,
      };

      // Client-side validation (basic)
      if (!formData.testDate || !formData.provider || !formData.testType) {
          showAlert('Please fill in Test Date, Provider, and Test Type.', 'warning');
          hideSpinner();
          return;
      }

      if (formData.testType === 'full') {
        formData.maths = document.getElementById('maths').value;
        formData.english = document.getElementById('english').value;
        formData.reasoning = document.getElementById('reasoning').value;
        formData.gk = document.getElementById('gk').value;
         if (formData.maths === "" || formData.english === "" || formData.reasoning === "" || formData.gk === "") {
             showAlert('Please fill in all marks for a Full Test.', 'warning');
             hideSpinner();
             return;
         }
      } else {
        formData.section = document.getElementById('section').value;
        formData.sectionMarks = document.getElementById('sectionMarks').value;
         if (formData.sectionMarks === "") {
              showAlert('Please enter marks for the Sectional Test.', 'warning');
              hideSpinner();
              return;
          }
      }

      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain;charset=utf-8', // Required for Apps Script doPost with text payload
          },
          body: JSON.stringify(formData)
        });

         if (!response.ok) {
            let errorMsg = `HTTP error! Status: ${response.status}`;
             try {
                 const errorData = await response.json();
                 errorMsg = errorData.message || errorMsg;
             } catch(e) { /* Ignore if response is not JSON */ }
             throw new Error(errorMsg);
         }

        const result = await response.json();

        if (result.status === 'success') {
          showAlert(result.message || 'Entry saved successfully!', 'success');
          form.reset(); // Clear the form
          document.getElementById('testDate').valueAsDate = new Date(); // Reset date
          toggleTestInputs(); // Reset input visibility
          fetchData(); // Refresh data on dashboard
        } else {
           throw new Error(result.message || 'Failed to save data via script.');
        }
      } catch (error) {
        console.error("Error saving data:", error);
        showAlert(`Error saving data: ${error.message}`, 'danger');
      } finally {
        hideSpinner();
      }
    }

    // --- Dashboard Update ---
    function updateDashboard() {
        if (!window.Chart || !window.Chart._adapters) {
             console.warn("Chart.js or adapter not ready yet.");
             setTimeout(updateDashboard, 100); // Retry shortly
             return;
         }

      // Filter data for charts (mostly full tests)
      const fullTestData = allTestData.filter(d => d.TestType === 'full' && d.TotalMarks !== null && d.Date)
                                      .sort((a, b) => new Date(a.Date) - new Date(b.Date)); // Sort chronologically for trend


      // 1. Progress Chart (Overall Score Trend)
      renderProgressChart(fullTestData);

      // 2. Section Average Chart
      renderSectionAvgChart(fullTestData);

      // 3. Provider Average Chart
      renderProviderAvgChart(fullTestData);

      // 4. Text Analysis
      renderTextAnalysis(allTestData); // Use all data for overall stats if needed
    }

    // --- Chart Rendering Functions ---
    function renderProgressChart(data) {
      const ctx = document.getElementById('progressChart').getContext('2d');
      const chartData = {
        labels: data.map(d => d.Date),
        datasets: [{
          label: 'Total Score',
          data: data.map(d => d.TotalMarks),
          borderColor: 'rgb(99, 102, 241)', // Primary color
          backgroundColor: 'rgba(99, 102, 241, 0.1)',
          fill: true,
          tension: 0.1, // Slight curve
          pointRadius: 4,
          pointHoverRadius: 6,
        }]
      };

      if (progressChartInstance) {
        progressChartInstance.destroy();
      }
       if (data.length === 0) {
            showNoDataMessage('progressChart');
            return;
        }

      progressChartInstance = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              type: 'time',
              time: { unit: 'day', tooltipFormat: 'MMM d, yyyy', displayFormats: { day: 'MMM d' } },
              title: { display: true, text: 'Date' },
               grid: { display: false }
            },
            y: {
              title: { display: true, text: 'Total Score (out of 200)' }, // Assuming CGL Tier 1
              beginAtZero: true,
               suggestedMax: 200
            }
          },
          plugins: {
              legend: { display: false },
              tooltip: {
                  mode: 'index',
                  intersect: false,
                  callbacks: {
                        title: function(context) {
                            // Format date in tooltip
                            return new Date(context[0].parsed.x).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                        }
                  }
              }
          },
          interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
      });
    }

    function renderSectionAvgChart(data) {
        const ctx = document.getElementById('sectionAvgChart').getContext('2d');
        const sections = ['Maths', 'English', 'Reasoning', 'GK'];
        const averages = { Maths: 0, English: 0, Reasoning: 0, GK: 0 };
        const counts = { Maths: 0, English: 0, Reasoning: 0, GK: 0 };

         if (data.length === 0) {
            showNoDataMessage('sectionAvgChart');
             if (sectionAvgChartInstance) sectionAvgChartInstance.destroy();
            return;
         }

        data.forEach(d => {
            sections.forEach(sec => {
                 // Check if the mark exists and is a number
                 if (d[sec] !== null && d[sec] !== undefined && !isNaN(Number(d[sec]))) {
                    averages[sec] += Number(d[sec]);
                    counts[sec]++;
                 }
            });
        });

        const avgData = sections.map(sec => counts[sec] > 0 ? (averages[sec] / counts[sec]) : 0);

        const chartData = {
            labels: sections,
            datasets: [{
                label: 'Average Score',
                data: avgData,
                backgroundColor: [
                    'rgba(54, 162, 235, 0.6)', // Blue
                    'rgba(255, 99, 132, 0.6)', // Red
                    'rgba(75, 192, 192, 0.6)', // Green
                    'rgba(255, 206, 86, 0.6)' // Yellow
                ],
                borderColor: [
                    'rgb(54, 162, 235)',
                    'rgb(255, 99, 132)',
                    'rgb(75, 192, 192)',
                    'rgb(255, 206, 86)'
                ],
                borderWidth: 1
            }]
        };

         if (sectionAvgChartInstance) {
            sectionAvgChartInstance.destroy();
         }


         sectionAvgChartInstance = new Chart(ctx, {
            type: 'bar', // Or 'radar'
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y', // Horizontal bars can be nice here
                scales: {
                    x: {
                        title: { display: true, text: 'Average Score (out of 50)' },
                        beginAtZero: true,
                        suggestedMax: 50
                    },
                     y: {
                         grid: { display: false }
                     }
                },
                plugins: {
                    legend: { display: false }
                }
            }
         });
    }

     function renderProviderAvgChart(data) {
        const ctx = document.getElementById('providerAvgChart').getContext('2d');
        const scoresByProvider = {};

         if (data.length === 0) {
            showNoDataMessage('providerAvgChart');
            if (providerAvgChartInstance) providerAvgChartInstance.destroy();
            return;
         }

        data.forEach(d => {
            const provider = d.Provider || 'Unknown';
            if (!scoresByProvider[provider]) {
                scoresByProvider[provider] = { total: 0, count: 0 };
            }
             // Check if TotalMarks exists and is a number
             if (d.TotalMarks !== null && d.TotalMarks !== undefined && !isNaN(Number(d.TotalMarks))) {
                 scoresByProvider[provider].total += Number(d.TotalMarks);
                 scoresByProvider[provider].count++;
             }

        });

        const labels = Object.keys(scoresByProvider);
        const avgData = labels.map(provider => scoresByProvider[provider].count > 0 ? (scoresByProvider[provider].total / scoresByProvider[provider].count) : 0);

         const backgroundColors = generateColorPalette(labels.length);

        const chartData = {
            labels: labels,
            datasets: [{
                label: 'Average Score',
                data: avgData,
                backgroundColor: backgroundColors.map(c => `${c}99`), // Add alpha
                borderColor: backgroundColors,
                borderWidth: 1
            }]
        };

         if (providerAvgChartInstance) {
            providerAvgChartInstance.destroy();
         }

         providerAvgChartInstance = new Chart(ctx, {
            type: 'bar',
            data: chartData,
             options: {
                responsive: true,
                maintainAspectRatio: false,
                 scales: {
                    y: {
                        title: { display: true, text: 'Average Total Score (out of 200)' },
                        beginAtZero: true,
                        suggestedMax: 200
                    },
                     x: {
                         grid: { display: false }
                     }
                },
                plugins: {
                    legend: { display: false }
                }
            }
         });
    }

    function showNoDataMessage(canvasId) {
        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear previous drawing
        ctx.save(); // Save default state
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = '#6c757d'; // Bootstrap muted color
        ctx.font = "16px 'Inter', sans-serif";
        // Adjust text position to be centered within the container
        const container = canvas.closest('.chart-container');
        const containerHeight = container ? container.clientHeight : canvas.height;
        const containerWidth = container ? container.clientWidth : canvas.width;
        ctx.fillText('No data available for this chart', containerWidth / 2, containerHeight / 2);
        ctx.restore(); // Restore default state
    }


     function generateColorPalette(count) {
         // Simple palette generator, can be expanded
         const baseColors = [
            'rgb(99, 102, 241)',  // Indigo
            'rgb(139, 92, 246)', // Violet
            'rgb(236, 72, 153)', // Pink
            'rgb(16, 185, 129)', // Emerald
            'rgb(245, 158, 11)', // Amber
             'rgb(59, 130, 246)', // Blue
             'rgb(239, 68, 68)'   // Red
         ];
         let colors = [];
         for (let i = 0; i < count; i++) {
             colors.push(baseColors[i % baseColors.length]);
         }
         return colors;
     }

    // --- Text Analysis ---
     function renderTextAnalysis(data) {
        const analysisDiv = document.getElementById('textAnalysis');
        const fullTestData = data.filter(d => d.TestType === 'full' && d.TotalMarks !== null && !isNaN(Number(d.TotalMarks)))
                                .sort((a, b) => new Date(a.Date) - new Date(b.Date)); // Sort oldest to newest for trend analysis

        if (fullTestData.length === 0) {
            analysisDiv.innerHTML = '<p class="text-muted">Not enough full test data available for analysis.</p>';
            return;
        }

        // Calculations
        const totalSum = fullTestData.reduce((sum, d) => sum + Number(d.TotalMarks), 0);
        const overallAvg = totalSum / fullTestData.length;

        const sections = ['Maths', 'English', 'Reasoning', 'GK'];
        const sectionAvgs = {};
        const sectionCounts = {};
         sections.forEach(sec => {
             sectionAvgs[sec] = 0;
             sectionCounts[sec] = 0;
             fullTestData.forEach(d => {
                if (d[sec] !== null && d[sec] !== undefined && !isNaN(Number(d[sec]))) {
                    sectionAvgs[sec] += Number(d[sec]);
                    sectionCounts[sec]++;
                }
             });
             if (sectionCounts[sec] > 0) {
                 sectionAvgs[sec] /= sectionCounts[sec];
             }
         });

        let bestSection = 'N/A';
        let worstSection = 'N/A';
        let maxAvg = -1;
        let minAvg = 51; // Higher than max possible score

        sections.forEach(sec => {
             if (sectionCounts[sec] > 0) { // Only consider sections with data
                 if (sectionAvgs[sec] > maxAvg) {
                     maxAvg = sectionAvgs[sec];
                     bestSection = sec;
                 }
                 if (sectionAvgs[sec] < minAvg) {
                     minAvg = sectionAvgs[sec];
                     worstSection = sec;
                 }
             }
         });

        const sortedByScore = [...fullTestData].sort((a, b) => Number(b.TotalMarks) - Number(a.TotalMarks));
        const highestScoreData = sortedByScore[0];
        const lowestScoreData = sortedByScore[sortedByScore.length - 1];

        // Recent Trend (e.g., last 5 tests)
        const numRecentTests = Math.min(5, fullTestData.length);
        const recentTests = fullTestData.slice(-numRecentTests);
        const recentSum = recentTests.reduce((sum, d) => sum + Number(d.TotalMarks), 0);
        const recentAvg = recentTests.length > 0 ? recentSum / recentTests.length : 0;
        let trendDirection = "Stable";
         if (recentTests.length > 1) { // Need at least 2 points for a trend direction
             const firstRecent = Number(recentTests[0].TotalMarks);
             const lastRecent = Number(recentTests[recentTests.length - 1].TotalMarks);
             if (lastRecent > firstRecent + 2) trendDirection = "Improving"; // Add a small threshold
             else if (lastRecent < firstRecent - 2) trendDirection = "Declining";
             // More sophisticated trend analysis (e.g., slope) could be added
         } else if (recentTests.length === 1 && fullTestData.length > 1) {
            // Compare single recent test to overall average before it
             const avgBeforeRecent = (totalSum - Number(recentTests[0].TotalMarks)) / (fullTestData.length - 1);
              if (Number(recentTests[0].TotalMarks) > avgBeforeRecent + 2) trendDirection = `Higher than previous average (${avgBeforeRecent.toFixed(1)})`;
              else if (Number(recentTests[0].TotalMarks) < avgBeforeRecent - 2) trendDirection = `Lower than previous average (${avgBeforeRecent.toFixed(1)})`;
         }


        // Generate HTML
        let analysisHtml = `
            <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    Overall Average Score: <span class="badge bg-primary rounded-pill">${overallAvg.toFixed(2)}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    Highest Score: <span class="badge bg-success rounded-pill">${highestScoreData.TotalMarks} (on ${new Date(highestScoreData.Date).toLocaleDateString('en-CA')})</span>
                 </li>
                 <li class="list-group-item d-flex justify-content-between align-items-center">
                    Lowest Score: <span class="badge bg-warning rounded-pill">${lowestScoreData.TotalMarks} (on ${new Date(lowestScoreData.Date).toLocaleDateString('en-CA')})</span>
                 </li>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    Strongest Section: <span class="badge bg-info rounded-pill">${bestSection} (Avg: ${sectionAvgs[bestSection] ? sectionAvgs[bestSection].toFixed(1) : 'N/A'})</span>
                 </li>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    Area for Improvement: <span class="badge bg-secondary rounded-pill">${worstSection} (Avg: ${sectionAvgs[worstSection] ? sectionAvgs[worstSection].toFixed(1) : 'N/A'})</span>
                 </li>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    Recent Trend (Last ${numRecentTests} Tests): <span class="badge bg-light text-dark rounded-pill">Avg: ${recentAvg.toFixed(1)} - ${trendDirection}</span>
                 </li>
            </ul>
            <p class="mt-3 text-muted small">Based on ${fullTestData.length} full test entries.</p>
          `;
        analysisDiv.innerHTML = analysisHtml;
      }


    // --- PDF Generation ---
    async function generatePdfReport() {
        // Check if libraries are loaded
        if (typeof jsPDF === 'undefined' || typeof autoTable === 'undefined') {
            showAlert('PDF generation library not loaded yet. Please wait a moment and try again.', 'warning');
            return;
        }
        if (allTestData.length === 0) {
            showAlert('No data available to generate a report.', 'warning');
            return;
        }

        showSpinner('Generating PDF Report...');
         await new Promise(resolve => setTimeout(resolve, 50)); // Small delay to allow spinner to render

        try {
            const doc = new jsPDF();
            const pageHeight = doc.internal.pageSize.height;
            const pageWidth = doc.internal.pageSize.width;
            const margin = 15;
            let cursorY = margin; // Track Y position

             // --- Helper to add text and move cursor ---
            const addText = (text, options = {}, increment = 5) => {
                if (cursorY + increment > pageHeight - margin) {
                    doc.addPage();
                    cursorY = margin;
                }
                doc.text(text, margin, cursorY, options);
                cursorY += increment;
            };

            // --- Title ---
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            addText('SSC Performance Report', { align: 'center', maxWidth: pageWidth - margin*2 }, 10);
             doc.setFontSize(10);
             doc.setFont(undefined, 'normal');
             addText(`Generated on: ${new Date().toLocaleDateString('en-CA')} ${new Date().toLocaleTimeString()}`, { align: 'center', maxWidth: pageWidth - margin*2 }, 10);


             // --- Summary Section (reuse text analysis logic) ---
             doc.setFontSize(14);
             doc.setFont(undefined, 'bold');
             addText('Performance Summary', {}, 8);
             doc.setFontSize(10);
             doc.setFont(undefined, 'normal');
             cursorY += 2; // Extra space

              // Simple text version of the analysis for PDF
              const analysisTextElement = document.getElementById('textAnalysis');
              if (analysisTextElement) {
                  const summaryItems = analysisTextElement.querySelectorAll('.list-group-item');
                  if (summaryItems.length > 0) {
                      summaryItems.forEach(item => {
                           // Basic text extraction, might need refinement for complex HTML
                           const textContent = item.textContent.replace(/\s+/g, ' ').trim();
                           addText(textContent, { maxWidth: pageWidth - margin * 2 }, 6);
                      });
                  } else {
                      addText('Summary data not available.', {}, 6);
                  }
              } else {
                   addText('Summary data not available.', {}, 6);
              }
               cursorY += 5; // Space after summary


             // --- Charts ---
             doc.addPage();
             cursorY = margin;
             doc.setFontSize(14);
             doc.setFont(undefined, 'bold');
             addText('Performance Charts', {}, 10);
             doc.setFontSize(10);
             doc.setFont(undefined, 'normal');

             const addChartToPdf = (chartInstance, title) => {
                  if (chartInstance && chartInstance.canvas) {
                      try {
                         const imgData = chartInstance.toBase64Image('image/png', 1.0); // Use PNG for better quality
                         const imgProps = doc.getImageProperties(imgData);
                         const imgWidth = pageWidth - margin * 2; // Full width
                         const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

                         if (cursorY + imgHeight + 15 > pageHeight - margin) { // Check space + title space
                              doc.addPage();
                              cursorY = margin;
                              // Re-add title if needed on new page
                              doc.setFontSize(12);
                              doc.setFont(undefined,'bold');
                              addText(title, {}, 8);
                              doc.setFont(undefined,'normal');
                         } else {
                              doc.setFontSize(12);
                              doc.setFont(undefined,'bold');
                              addText(title, {}, 8);
                              doc.setFont(undefined,'normal');
                         }

                         doc.addImage(imgData, 'PNG', margin, cursorY, imgWidth, imgHeight);
                         cursorY += imgHeight + 10; // Add space after chart
                      } catch (imgError) {
                          console.error("Error adding chart image:", imgError);
                          addText(`Error rendering chart: ${title}`, {}, 6);
                      }

                  } else {
                      addText(`Chart not available: ${title}`, {}, 6);
                  }
             };

             addChartToPdf(progressChartInstance, 'Overall Score Trend');
             addChartToPdf(sectionAvgChartInstance, 'Average Score per Section');
             addChartToPdf(providerAvgChartInstance, 'Average Score by Provider');


             // --- Detailed Marks Table ---
             doc.addPage();
             cursorY = margin;
             doc.setFontSize(14);
             doc.setFont(undefined, 'bold');
              addText('Detailed Test Data', {}, 10); // Use addText to manage pages
             doc.setFontSize(10);
             doc.setFont(undefined, 'normal');


            const tableColumns = [
                { header: 'Date', dataKey: 'Date' },
                { header: 'Provider', dataKey: 'Provider' },
                { header: 'Type', dataKey: 'TestType' },
                { header: 'Section', dataKey: 'Section' }, // Will be empty for full
                { header: 'M', dataKey: 'Maths' },
                { header: 'E', dataKey: 'English' },
                { header: 'R', dataKey: 'Reasoning' },
                { header: 'G', dataKey: 'GK' },
                { header: 'Total', dataKey: 'TotalMarks' },
                { header: 'Notes', dataKey: 'Notes' }
            ];

             // Prepare data - format dates and numbers, handle nulls
            const tableData = allTestData.map(d => ({
                Date: d.Date ? new Date(d.Date).toLocaleDateString('en-CA') : 'N/A', // YYYY-MM-DD
                Provider: d.Provider || '',
                TestType: d.TestType || '',
                Section: d.Section || '', // Empty string if null/undefined
                 Maths: (d.Maths !== null && d.Maths !== undefined) ? Number(d.Maths).toFixed(1) : '-', // Show '-' for null
                 English: (d.English !== null && d.English !== undefined) ? Number(d.English).toFixed(1) : '-',
                 Reasoning: (d.Reasoning !== null && d.Reasoning !== undefined) ? Number(d.Reasoning).toFixed(1) : '-',
                 GK: (d.GK !== null && d.GK !== undefined) ? Number(d.GK).toFixed(1) : '-',
                 TotalMarks: (d.TotalMarks !== null && d.TotalMarks !== undefined) ? Number(d.TotalMarks).toFixed(2) : '-',
                 Notes: d.Notes || ''
            }));

             // Use autoTable
             doc.autoTable({
                head: [tableColumns.map(col => col.header)], // Extract header titles
                body: tableData.map(row => tableColumns.map(col => row[col.dataKey])), // Map data keys
                startY: cursorY,
                theme: 'grid', // 'striped', 'grid', 'plain'
                 styles: { fontSize: 8, cellPadding: 1.5 },
                 headStyles: { fillColor: [99, 102, 241], textColor: 255, fontStyle: 'bold' }, // Primary color header
                 columnStyles: {
                     Notes: { cellWidth: 'wrap' }, // Wrap notes column
                     Date: { cellWidth: 20 },
                     Provider: { cellWidth: 20 },
                     Type: {cellWidth: 15},
                     Section: {cellWidth: 15},
                     M: { halign: 'center', cellWidth: 10}, // Center align marks
                     E: { halign: 'center', cellWidth: 10},
                     R: { halign: 'center', cellWidth: 10},
                     G: { halign: 'center', cellWidth: 10},
                     TotalMarks: { halign: 'center', cellWidth: 15, fontStyle: 'bold'} // Bold total
                 },
                 didDrawPage: function (data) {
                      // Add page numbers in footer
                      doc.setFontSize(8);
                      doc.setTextColor(150);
                      doc.text('Page ' + doc.internal.getNumberOfPages(), pageWidth - margin, pageHeight - 10, { align: 'right' });
                 }
            });

            // --- Save PDF ---
            doc.save(`SSC_Performance_Report_${new Date().toISOString().slice(0, 10)}.pdf`);
            showAlert('PDF Report generated successfully!', 'success');

        } catch (error) {
            console.error("Error generating PDF:", error);
            showAlert(`Error generating PDF: ${error.message}`, 'danger');
        } finally {
            hideSpinner();
        }
    }

  </script>
</body>
</html>
