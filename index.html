<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSC Tracker - Your Preparation Companion</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
        }
        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', system-ui;
        }
        .brand-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        .section-input {
            transition: transform 0.2s ease;
        }
        .section-input:hover {
            transform: translateY(-3px);
        }
    </style>
</head>
<body>
    <header class="brand-header text-white py-4 mb-5">
        <div class="container text-center">
            <h1 class="display-4 fw-bold mb-2">ðŸ“˜ SSC Tracker</h1>
            <p class="lead mb-0">Master Your SSC Preparation â€¢ By Advani Ji</p>
        </div>
    </header>

    <div class="container">
        <!-- Login Section -->
        <div id="loginSection" class="glass-card p-4 mb-4">
            <div class="row g-3 align-items-center">
                <div class="col-md-4">
                    <select id="username" class="form-select form-select-lg">
                        <option>Advani</option>
                        <option>Siamaq</option>
                        <option>Souvik</option>
                        <option>Other</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="password" id="password" class="form-control form-control-lg" placeholder="Your Password">
                </div>
                <div class="col-md-4">
                    <button onclick="login()" class="btn btn-lg btn-light w-100">ðŸ”‘ Login</button>
                </div>
            </div>
        </div>

        <!-- Data Entry Form -->
        <div id="dataForm" class="glass-card p-4 mb-4" style="display: none;">
            <div class="row g-3">
                <div class="col-md-3">
                    <input type="text" id="testID" class="form-control form-control-lg" placeholder="Test ID">
                </div>
                <div class="col-md-3">
                    <select id="testType" class="form-select form-select-lg">
                        <option value="full">Full Test (200)</option>
                        <option value="sectional">Sectional Test (50)</option>
                    </select>
                </div>
                
                <!-- Full Test Sections -->
                <div id="fullTestSections" class="row g-3 mt-2" style="display: none;">
                    <div class="col-3">
                        <div class="section-input card p-2 text-center">
                            <label class="text-muted small mb-1">Maths</label>
                            <input type="number" class="form-control full-section" max="50" placeholder="/50">
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="section-input card p-2 text-center">
                            <label class="text-muted small mb-1">Reasoning</label>
                            <input type="number" class="form-control full-section" max="50" placeholder="/50">
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="section-input card p-2 text-center">
                            <label class="text-muted small mb-1">English</label>
                            <input type="number" class="form-control full-section" max="50" placeholder="/50">
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="section-input card p-2 text-center">
                            <label class="text-muted small mb-1">GK</label>
                            <input type="number" class="form-control full-section" max="50" placeholder="/50">
                        </div>
                    </div>
                </div>

                <!-- Sectional Test Input -->
                <div id="sectionalTest" class="col-md-3" style="display: none;">
                    <select id="section" class="form-select form-select-lg">
                        <option>Maths</option>
                        <option>Reasoning</option>
                        <option>English</option>
                        <option>GK</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <button onclick="submitData()" class="btn btn-lg btn-primary w-100">ðŸ’¾ Save Entry</button>
                </div>
            </div>
        </div>

        <!-- Analysis Section -->
        <div class="glass-card p-4 mb-4">
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Progress Timeline</h5>
                            <canvas id="progressChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Section Performance</h5>
                            <canvas id="sectionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <button onclick="generatePDF()" class="btn btn-danger btn-lg">
                    ðŸ“„ Generate PDF Report
                </button>
            </div>
        </div>
    </div>

    <!-- Required Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        // Configuration
        const SHEET_ID = '1m6gtbbqfwdrYKj5mo4dP2oH9Xbx-jDAFiCXqK94OrVQ';
        const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby5EHvkWhj2Im0GNAZ4C2LPEGqPrlM_dq8c55Vtsx43UHvXZpomelwoYPKg444zGjk/exec';
        
        // State Management
        let currentUser = null;
        let progressChart, sectionChart;

        // Login System
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('passwords.json');
                const passwords = await response.json();
                
                if(passwords[username] === password) {
                    currentUser = username;
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('dataForm').style.display = 'block';
                    loadCharts();
                    setupFormToggle();
                } else {
                    alert('ðŸ”’ Incorrect password!');
                }
            } catch (error) {
                alert('ðŸš¨ Error loading passwords!');
            }
        }

        // Form Interactions
        function setupFormToggle() {
            document.getElementById('testType').addEventListener('change', function() {
                const isFullTest = this.value === 'full';
                document.getElementById('fullTestSections').style.display = isFullTest ? 'flex' : 'none';
                document.getElementById('sectionalTest').style.display = isFullTest ? 'none' : 'block';
            });
        }

        // Data Submission
        async function submitData() {
            const entries = [];
            const testType = document.getElementById('testType').value;

            if(testType === 'full') {
                document.querySelectorAll('.full-section').forEach(input => {
                    entries.push({
                        testID: document.getElementById('testID').value,
                        testType: 'full',
                        section: input.parentElement.querySelector('label').textContent.trim(),
                        marks: input.value
                    });
                });
            } else {
                entries.push({
                    testID: document.getElementById('testID').value,
                    testType: 'sectional',
                    section: document.getElementById('section').value,
                    marks: document.getElementById('marks').value
                });
            }

            try {
                const responses = await Promise.all(
                    entries.map(entry => 
                        fetch(APP_SCRIPT_URL, {
                            method: 'POST',
                            body: JSON.stringify({ username: currentUser, ...entry })
                        })
                );
                
                if(responses.every(r => r.ok)) {
                    alert('âœ… Data saved successfully!');
                    loadCharts();
                }
            } catch (error) {
                alert(`âŒ Error: ${error.message}`);
            }
        }

        // Chart System
        async function loadCharts() {
            const data = await fetch(`https://opensheet.elk.sh/${SHEET_ID}/${currentUser}`)
                .then(r => r.json());

            // Destroy existing charts
            [progressChart, sectionChart].forEach(chart => chart?.destroy());

            // Progress Timeline
            progressChart = new Chart(document.getElementById('progressChart'), {
                type: 'line',
                data: {
                    labels: data.map(entry => new Date(entry.Date).toLocaleDateString()),
                    datasets: [{
                        label: 'Marks Progress',
                        data: data.map(entry => entry.Marks),
                        borderColor: '#3498db',
                        tension: 0.2
                    }]
                }
            });

            // Section Performance
            sectionChart = new Chart(document.getElementById('sectionChart'), {
                type: 'bar',
                data: {
                    labels: ['Maths', 'Reasoning', 'English', 'GK'],
                    datasets: [{
                        label: 'Average Marks',
                        data: calculateSectionAverages(data),
                        backgroundColor: '#2ecc71'
                    }]
                }
            });
        }

        function calculateSectionAverages(data) {
            // Implementation for section averages
            // ... (existing logic from previous implementation)
        }

        // PDF Generation
        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(22);
            doc.text("SSC Tracker Report", 15, 15);
            doc.setFontSize(12);
            doc.text(`User: ${currentUser}`, 15, 25);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 15, 30);

            // Add Charts
            const charts = ['progressChart', 'sectionChart'];
            let yPos = 40;
            
            for(const chartId of charts) {
                const canvas = document.getElementById(chartId);
                const imgData = await html2canvas(canvas).then(c => c.toDataURL('image/png'));
                doc.addImage(imgData, 'PNG', 15, yPos, 180, 80);
                yPos += 90;
            }

            // Footer
            doc.setFontSize(10);
            doc.text("Created with SSC Tracker - By Advani Ji", 15, doc.internal.pageSize.height - 10);

            doc.save(`SSC_Report_${currentUser}.pdf`);
        }
    </script>
</body>
</html>
