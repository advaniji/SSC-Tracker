<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Exam Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chart-container { max-width: 1000px; margin: 40px auto; }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <!-- Login Section -->
        <div id="loginSection" class="card mb-4">
            <div class="card-body">
                <h2 class="mb-4">Login</h2>
                <div class="row g-3">
                    <div class="col-md-4">
                        <select id="username" class="form-select">
                            <option>Advani</option>
                            <option>Siamaq</option>
                            <option>Souvik</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="password" id="password" class="form-control" placeholder="Password">
                    </div>
                    <div class="col-md-4">
                        <button onclick="login()" class="btn btn-primary w-100">Login</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Entry Form -->
        <div id="dataForm" class="card mb-4" style="display: none;">
            <div class="card-body">
                <h2 class="mb-4">Enter Marks</h2>
                <div class="row g-3">
                    <div class="col-md-3">
                        <input type="text" id="testID" class="form-control" placeholder="Test ID">
                    </div>
                    <div class="col-md-3">
                        <select id="testType" class="form-select">
                            <option value="full">Full Test (200)</option>
                            <option value="sectional">Sectional Test (50)</option>
                        </select>
                    </div>
                    <div class="col-md-3" id="sectionGroup" style="display: none;">
                        <select id="section" class="form-select">
                            <option>Maths</option>
                            <option>Reasoning</option>
                            <option>English</option>
                            <option>GK</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="number" id="marks" class="form-control" placeholder="Marks" required>
                    </div>
                    <div class="col-12">
                        <input type="text" id="notes" class="form-control" placeholder="Notes">
                    </div>
                    <div class="col-12">
                        <button onclick="submitData()" class="btn btn-success">Save Entry</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Chart -->
        <div class="card">
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Passwords (replace with your actual passwords.json path)
        let passwords = {};
        fetch('passwords.json')
            .then(response => response.json())
            .then(data => passwords = data);

        // Login Handler
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if(passwords[username] === password) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('dataForm').style.display = 'block';
                loadChart(username);
            } else {
                alert('Invalid password!');
            }
        }

        // Toggle Section Input
        document.getElementById('testType').addEventListener('change', function() {
            document.getElementById('sectionGroup').style.display = 
                this.value === 'sectional' ? 'block' : 'none';
        });

        // Submit Data
        async function submitData() {
            const data = {
                username: document.getElementById('username').value,
                testID: document.getElementById('testID').value,
                testType: document.getElementById('testType').value,
                section: document.getElementById('testType').value === 'sectional' 
                        ? document.getElementById('section').value 
                        : 'Full Test',
                marks: document.getElementById('marks').value,
                notes: document.getElementById('notes').value
            };

            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycby5EHvkWhj2Im0GNAZ4C2LPEGqPrlM_dq8c55Vtsx43UHvXZpomelwoYPKg444zGjk/exec', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                if(await response.text() === 'Success') {
                    alert('Saved!');
                    document.getElementById('marks').value = '';
                    document.getElementById('notes').value = '';
                    loadChart(data.username);
                }
            } catch (error) {
                alert('Error saving data: ' + error);
            }
        }

        // Load Chart
        let chart;
        async function loadChart(username) {
            const response = await fetch(`https://opensheet.elk.sh/1m6gtbbqfwdrYKj5mo4dP2oH9Xbx-jDAFiCXqK94OrVQ/${username}`);
            const sheetData = await response.json();
            
            if(chart) chart.destroy();
            
            chart = new Chart(document.getElementById('progressChart'), {
                type: 'line',
                data: {
                    labels: sheetData.map(entry => entry.Date),
                    datasets: [{
                        label: 'Marks Progress',
                        data: sheetData.map(entry => entry.Marks),
                        borderColor: '#4CAF50',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Performance Over Time' }
                    }
                }
            });
        }
    </script>
</body>
</html>
