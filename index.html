<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Test Progress Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- FontAwesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- html2pdf.js (for PDF generation on analysis page if needed) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
</head>
<body>
  <div class="container my-4">
    <!-- Login Section -->
    <div id="loginSection">
      <h2 class="mb-3">Login</h2>
      <form id="loginForm">
        <div class="mb-3">
          <label for="username" class="form-label">Username</label>
          <input type="text" id="username" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="password" class="form-label">Password</label>
          <input type="password" id="password" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary"><i class="fa fa-sign-in-alt"></i> Login</button>
      </form>
      <div id="loginError" class="text-danger mt-2"></div>
    </div>

    <!-- Main Content Section (hidden until login) -->
    <div id="mainContent" style="display:none;">
      <h2 class="mt-4">Enter Test Data</h2>
      <form id="testForm">
        <div class="row">
          <div class="col-md-4 mb-3">
            <label for="testId" class="form-label">Test ID</label>
            <input type="text" id="testId" class="form-control" placeholder="Leave blank to auto-generate">
          </div>
          <div class="col-md-4 mb-3">
            <label for="testDate" class="form-label">Date</label>
            <!-- Default to today's date; disable manual typing -->
            <input type="date" id="testDate" class="form-control" required onkeydown="return false;">
          </div>
          <div class="col-md-4 mb-3">
            <label for="testType" class="form-label">Test Type</label>
            <select id="testType" class="form-select" required>
              <option value="full">Full Test</option>
              <option value="sectional">Sectional Test</option>
            </select>
          </div>
        </div>

        <div class="row">
          <!-- Optional Section field -->
          <div class="col-md-4 mb-3">
            <label for="section" class="form-label">Section</label>
            <input type="text" id="section" class="form-control" placeholder="Enter section (if any)">
          </div>
          <div class="col-md-4 mb-3">
            <label for="provider" class="form-label">Provider</label>
            <select id="provider" class="form-select" required>
              <option value="Oliveboard">Oliveboard</option>
              <option value="RBE">RBE</option>
              <option value="Testbook">Testbook</option>
              <option value="The Pundits">The Pundits</option>
              <option value="Others">Others</option>
            </select>
          </div>
          <div class="col-md-4 mb-3">
            <label for="notes" class="form-label">Notes</label>
            <input type="text" id="notes" class="form-control">
          </div>
        </div>

        <h4>Marks (each out of 50)</h4>
        <div class="row">
          <div class="col-md-3 mb-3">
            <label for="maths" class="form-label">Maths</label>
            <input type="number" id="maths" class="form-control" max="50" required>
          </div>
          <div class="col-md-3 mb-3">
            <label for="english" class="form-label">English</label>
            <input type="number" id="english" class="form-control" max="50" required>
          </div>
          <div class="col-md-3 mb-3">
            <label for="reasoning" class="form-label">Reasoning</label>
            <input type="number" id="reasoning" class="form-control" max="50" required>
          </div>
          <div class="col-md-3 mb-3">
            <label for="gk" class="form-label">GK</label>
            <input type="number" id="gk" class="form-control" max="50" required>
          </div>
        </div>
        <button type="submit" class="btn btn-success"><i class="fa fa-save"></i> Submit Test Data</button>
      </form>

      <!-- Graphs Section -->
      <h2 class="mt-5">Progress Tracker</h2>
      <div class="row">
        <!-- Overall Tracker: Overall Marks over Time -->
        <div class="col-md-6">
          <canvas id="overallChart"></canvas>
        </div>
        <!-- Subject Tracker: Line graphs for each subject -->
        <div class="col-md-6">
          <canvas id="subjectChart"></canvas>
        </div>
      </div>

      <!-- Link to Complete Analysis Page -->
      <div class="mt-4">
        <a href="marks.html" class="btn btn-primary"><i class="fa fa-chart-line"></i> Complete Analysis</a>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // Set the testDate input to today's date (YYYY-MM-DD format)
    document.addEventListener("DOMContentLoaded", function() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('testDate').value = today;
    });

    // Global variables for storing credentials, service account info, and the logged-in username.
    let userCredentials = [];
    let googleServiceAccount = {};
    let loggedInUser = ""; // stores the username after login

    // Load passwords from passwords.json (place this file in the same folder)
    fetch('./passwords.json')
      .then(response => response.json())
      .then(data => {
        // Convert passwords.json into an array of objects: { username, password }
        userCredentials = Object.keys(data).map(username => ({
          username: username.toLowerCase(),
          password: data[username]
        }));
      })
      .catch(err => console.error("Error loading passwords.json:", err));

    // Load Google Service Account JSON from marks.json (for future use)
    fetch('./marks.json')
      .then(response => response.json())
      .then(data => {
        googleServiceAccount = data;
        console.log("Google Service Account loaded:", googleServiceAccount);
      })
      .catch(err => console.error("Error loading marks.json:", err));

    // Simple login logic using credentials from passwords.json
    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const username = document.getElementById('username').value.trim().toLowerCase();
      const password = document.getElementById('password').value;
      const validUser = userCredentials.find(u => u.username === username && u.password === password);
      if (validUser) {
        loggedInUser = validUser.username; // store logged-in username
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
      } else {
        document.getElementById('loginError').innerText = 'Invalid credentials';
      }
    });

    // Array to store test data locally (for demo purposes)
    let testData = [];

    // URL of your deployed Google Apps Script Web App (replace with your actual URL)
    const scriptUrl = "https://script.google.com/macros/s/AKfycbxXf0qT6QWrqSy7td0HAmcM9a36mVCvasRnKwBiWbnkNTzbxvVXDRirm19oQZfMSRp0/exec";

    // Handle test form submission
    document.getElementById('testForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Get values from form
      let testId = document.getElementById('testId').value.trim();
      if (!testId) {
        // Auto-generate test id if not provided
        testId = 'T' + Math.floor(Math.random() * 100000);
      }
      const testDate = document.getElementById('testDate').value;
      const testType = document.getElementById('testType').value;
      const section = document.getElementById('section').value;  // Optional field
      const provider = document.getElementById('provider').value;
      const notes = document.getElementById('notes').value;
      const maths = parseFloat(document.getElementById('maths').value);
      const english = parseFloat(document.getElementById('english').value);
      const reasoning = parseFloat(document.getElementById('reasoning').value);
      const gk = parseFloat(document.getElementById('gk').value);
      
      // Calculate overall marks (sum of all subjects)
      const totalMarks = maths + english + reasoning + gk;
      
      // Build test entry object (without percentage)
      const testEntry = { 
        username: loggedInUser,  // used to select the correct sheet in Google Apps Script
        testId, 
        testDate, 
        testType, 
        section, 
        totalMarks,  // Overall marks
        notes, 
        provider, 
        maths, 
        english, 
        reasoning, 
        gk
      };
      
      testData.push(testEntry);
      alert('Test data submitted locally!');
      updateCharts();
      
      // Send testEntry to your Google Apps Script endpoint for writing to the sheet.
      fetch(scriptUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(testEntry)
      })
      .then(response => response.json())
      .then(data => console.log("Data sent to sheet:", data))
      .catch(err => console.error("Error sending data:", err));
    });

    // Initialize Charts using Chart.js
    let overallChart, subjectChart;
    function updateCharts() {
      // Prepare data for overall tracker (using test dates vs. overall marks)
      const labels = testData.map(entry => entry.testDate);
      const overallData = testData.map(entry => entry.totalMarks);

      // Destroy previous charts if they exist
      if (overallChart) overallChart.destroy();
      if (subjectChart) subjectChart.destroy();

      // Overall Tracker Chart
      const overallCtx = document.getElementById('overallChart').getContext('2d');
      overallChart = new Chart(overallCtx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Overall Marks',
            data: overallData,
            borderColor: 'blue',
            backgroundColor: 'lightblue',
            fill: false
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });

      // Subject Tracker Chart (line graphs for each subject)
      const mathsData = testData.map(entry => entry.maths);
      const englishData = testData.map(entry => entry.english);
      const reasoningData = testData.map(entry => entry.reasoning);
      const gkData = testData.map(entry => entry.gk);

      const subjectCtx = document.getElementById('subjectChart').getContext('2d');
      subjectChart = new Chart(subjectCtx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            { label: 'Maths', data: mathsData, borderColor: 'red', fill: false },
            { label: 'English', data: englishData, borderColor: 'green', fill: false },
            { label: 'Reasoning', data: reasoningData, borderColor: 'orange', fill: false },
            { label: 'GK', data: gkData, borderColor: 'purple', fill: false }
          ]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              max: 50
            }
          }
        }
      });
    }
  </script>
  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
